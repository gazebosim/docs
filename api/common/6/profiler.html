<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=9"/>
    <meta name="keywords" content="Gazebo Common">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Gazebo Common: Profiler</title>
    <script type="text/javascript" src="https://gazebosim.org/assets/doxygen/dynsections.js"></script>
    <script type="text/javascript" src="jquery.js"></script>
    <link rel="icon" type="image/x-icon" href="https://gazebosim.org/assets/icon/favicon.ico">
    <link href='http://fonts.googleapis.com/css?family=Roboto:400,300,100,500,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.deep_orange-blue.min.css">
    <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>
    <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"> </script>
    <link href="https://gazebosim.org/assets/doxygen/doxygen.css" rel="stylesheet" type="text/css">
  </head>
    <script type="text/javascript">
      /* Replace all the "permalink" &#9670;&nbsp; icons with a unicode link
        symbol.*/
      $(document).ready(function() {
        var elems = document.getElementsByClassName("permalink");
        for (var i = 0; i < elems.length; ++i) {
          elems[i].firstChild.innerHTML="&#x1f517;";
          elems[i].firstChild.style.fontSize="18px";
        }
      });
    </script>
  </head>
<body>
  <div class="mdl-layout mdl-js-layout mdl-layout--fixed-drawer">
    <div class="mdl-layout__drawer mdl-color--grey-100 mdl-color-text--blue-grey-50">
      <header class="mdl-color--grey-100">
        <a href="index.html"><img width="60px" src="https://gazebosim.org/assets/doxygen/gazebo_logo.svg"/></a>
        <h1 class="project_title">Gazebo Common</h1>
        <h2>API Reference</h2>
        <div class="version">
        6.0.0
        </div>
      </header>
      <!-- NOTE: If you add a link to a doxygen generated page, then make
                 sure to update the required_html_fils list in
                 GzCreateDocs.cmake -->
      <nav class="gz-navigation mdl-navigation">
        <a class="mdl-navigation__link" href="tutorials.html">
          <i class="mdl-color-text--grey-400 material-icons"
             role="presentation">insert_drive_file</i>Tutorials</a>
        <a id="class_menu" class="mdl-navigation__link" href="#">
          <i class="mdl-color-text--grey-400 material-icons"
             role="presentation">library_books</i>Classes</a>
        <a id="namespaces_menu"class="mdl-navigation__link" href="#">
          <i class="mdl-color-text--grey-400 material-icons"
             role="presentation">toc</i>Namespaces</a>
        <a class="mdl-navigation__link" href="files.html">
          <i class="mdl-color-text--grey-400 material-icons"
             role="presentation">insert_drive_file</i>Files</a>
        <a class="mdl-navigation__link" target="_blank"
           href="http://gazebosim.org">
          <i class="mdl-color-text--grey-400 material-icons"
             role="presentation">launch</i>Gazebo Website</a>
      </nav>
      <!-- classes sub menu -->
      <ul for="class_menu" class="mdl-menu mdl-menu--bottom-left mdl-js-menu mdl-js-ripple-effect mdl-navigation">
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link" href="classes.html">Index</a>
        </li>
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link"
            href="annotated.html">List</a>
        </li>
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link"
             href="hierarchy.html">Hierarchy</a>
        </li>
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link"
             href="functions.html">Members: All</a>
        </li>
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link"
             href="functions_func.html">Members: Functions</a>
        </li>
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link"
             href="functions_vars.html">Members: Variables</a>
        </li>
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link"
             href="functions_type.html">Members: Typedefs</a>
        </li>
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link"
             href="functions_enum.html">Members: Enumerations</a>
        </li>
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link"
             href="functions_eval.html">Members: Enumerator</a>
        </li>
      </ul>
      <!-- namespaces sub menu -->
      <ul for="namespaces_menu" class="mdl-menu mdl-menu--bottom-left mdl-js-menu mdl-js-ripple-effect mdl-navigation">
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link"
            href="namespaces.html">List</a>
        </li>
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link"
            href="namespacemembers.html">Members</a>
        </li>
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link"
            href="namespacemembers_func.html">Functions</a>
        </li>
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link"
            href="namespacemembers_type.html">Typedefs</a>
        </li>
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link"
            href="namespacemembers_vars.html">Variables</a>
        </li>
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link"
            href="namespacemembers_enum.html">Enumerations</a>
        </li>
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link"
            href="namespacemembers_eval.html">Enumerator</a>
        </li>
      </ul>
    </div>
    <main class="mdl-layout__content mdl-color--white">
    <div id="top">
<!-- Generated by Doxygen 1.9.8 -->
</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">Profiler</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Next Tutorial: <a class="el" href="hw-encoding.html">Hardware-accelerated Video Encoding</a></p>
<h2><a class="anchor" id="autotoc_md33"></a>
Overview</h2>
<p>This tutorial describes how to get started using the Gazebo Common profiler to measure and visualize run-time performance of your software.</p>
<p>The <code><a class="el" href="classgz_1_1common_1_1Profiler.html" title="Used to perform application-wide performance profiling.">gz::common::Profiler</a></code> provides a common interface that can allow for multiple underlying profiler implementations. Currently, the only available implementation is <a href="https://github.com/Celtoys/Remotery">Remotery</a>.</p>
<p>The goal of the profiler is to provide introspection and analysis when enabled at compile time, but to introduce no overhead when it is disabled at compile-time.</p>
<p>To control if the profiler is enabled, set the <code>GZ_PROFILER_ENABLE</code> flag using cmake on the targets or sources that you are interested in (described below).</p>
<h2><a class="anchor" id="autotoc_md34"></a>
Enabling the Profiler</h2>
<h3><a class="anchor" id="autotoc_md35"></a>
On custom example</h3>
<p>In order to use the profiler, inspection points must be added to the source code, and the application or library must be linked to the <code>gz-common::profiler</code> component.</p>
<p>To start, download the <a href="https://github.com/gazebosim/gz-common/raw/main/examples/profiler.cc">profiler.cc</a> example.</p>
<p>The relevant corresponding C++ would be as follows:</p>
<div class="fragment"><div class="line"><span class="comment">// Add the profiler header</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="Profiler_8hh.html">gz/common/Profiler.hh</a>&gt;</span></div>
<div class="line"> </div>
<div class="line">...</div>
<div class="line">void thread(<span class="keyword">const</span> <span class="keywordtype">char</span> *_thread_name)</div>
<div class="line">{</div>
<div class="line">  <span class="comment">// Sets the name of the thread to appear in the UI</span></div>
<div class="line">  <a class="code hl_define" href="Profiler_8hh.html#a969e457aa69134b1852732ad1b7695b3">GZ_PROFILE_THREAD_NAME</a>(_thread_name);</div>
<div class="line">  <span class="keywordflow">while</span> (running)</div>
<div class="line">  {</div>
<div class="line">    <span class="comment">// Add a profiling point to this scope.</span></div>
<div class="line">    <a class="code hl_define" href="Profiler_8hh.html#a3fb61457508d9f964278538e2708dfda">GZ_PROFILE</a>(<span class="stringliteral">&quot;Loop&quot;</span>);</div>
<div class="line">    <span class="comment">// Execute some arbitrary tasks</span></div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> ii = 0; ii &lt; 10; ++ii)</div>
<div class="line">    {</div>
<div class="line">      task1();</div>
<div class="line">    }</div>
<div class="line">    task2();</div>
<div class="line">    task3();</div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --><p>Update your CMakeLists.txt to the following. Note that the profiler must be enabled at compile time in order to function.</p>
<div class="fragment"><div class="line">cmake_minimum_required(VERSION 3.22.1 FATAL_ERROR)</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor"># Find the gz-common library</span></div>
<div class="line">find_package(<a class="code hl_namespace" href="namespacegz.html" title="Forward declarations for the common classes.">gz</a>-common6 QUIET REQUIRED COMPONENTS profiler)</div>
<div class="line"> </div>
<div class="line">add_executable(profiler_example profiler.cc)</div>
<div class="line">target_link_libraries(profiler_example <a class="code hl_namespace" href="namespacegz.html" title="Forward declarations for the common classes.">gz</a>-common6::profiler)</div>
<div class="line"><span class="preprocessor"># Enable the profiler for the example</span></div>
<div class="line">target_compile_definitions(profiler_example PUBLIC <span class="stringliteral">&quot;GZ_PROFILER_ENABLE=1&quot;</span>)</div>
</div><!-- fragment --><p>Run <code>cmake</code> and build the example</p>
<div class="fragment"><div class="line">cd build</div>
<div class="line">cmake ..</div>
<div class="line">make profiler_example</div>
</div><!-- fragment --><p>Then execute the example and the profiler visualization:</p>
<p>From terminal 1:</p>
<div class="fragment"><div class="line">./profiler_example</div>
</div><!-- fragment --><p>From terminal 2, open the visualizer using one of the following commands</p>
<div class="fragment"><div class="line"># Find the launcher script and use it (Linux and macOS)</div>
<div class="line">find /usr | grep gz_remotery_vis</div>
<div class="line">...</div>
<div class="line"> </div>
<div class="line">/usr/&lt;path_to&gt;/gz_remotery_vis</div>
<div class="line"> </div>
<div class="line"># Use the source path (Linux)</div>
<div class="line"># Substitute the path to your gz-common source checkout</div>
<div class="line">xdg-open $SOURCE_DIR/gz-common/profiler/src/Remotery/vis/index.html</div>
<div class="line"> </div>
<div class="line"># Use the installation path (Linux)</div>
<div class="line"># This may vary depending on where you have choosen to install</div>
<div class="line">xdg-open /usr/share/gz/gz-common6/profiler_vis/index.html</div>
<div class="line"> </div>
<div class="line"># Use the installation path (macOS)</div>
<div class="line">open /usr/share/gz/gz-common6/profiler_vis/index.html</div>
<div class="line"> </div>
<div class="line"># Inside a Docker container with port 8000 exposed</div>
<div class="line"># 1. Find your container&#39;s IP with &#39;ifconfig&#39;</div>
<div class="line"># 2. Start a basic web server:</div>
<div class="line">python3 -m http.server $SOURCE_DIR/gz-common/profiler/src/Remotery/vis/index.html</div>
<div class="line"># 3. Open URL &quot;http://&lt;container IP&gt;:8000/&quot; with a browser on the host.</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md36"></a>
On Gazebo library</h3>
<p>If you want to use profiler on any other Gazebo library, enable the profiler at compile time with <code>ENABLE_PROFILER</code> cmake argument.</p>
<p>When compiling with <code>CMake</code>: </p><div class="fragment"><div class="line">cmake .. -DENABLE_PROFILER=1</div>
</div><!-- fragment --><p> When compiling with <code>colcon</code>: </p><div class="fragment"><div class="line">colcon build --cmake-args -DENABLE_PROFILER=1</div>
</div><!-- fragment --><p>Run your Gazebo library then go to your Gazebo installation path and open the profiler browser using: </p><div class="fragment"><div class="line">&lt;workspace&gt;/install/libexec/gz/gz-common&lt;N&gt;/gz_remotery_vis</div>
</div><!-- fragment --><p>If the profiler is run successfully, you should see output in a browser. Similar to this</p>
<p><img src="https://raw.githubusercontent.com/gazebosim/gz-common/main/tutorials/imgs/profiler_tutorial_example.png" alt="" class="inline"/></p>
<h3><a class="anchor" id="autotoc_md37"></a>
Troubleshoot the web viewer</h3>
<p>If you see <code>connection error</code>, there are a couple of things to double check</p><ol type="1">
<li>Was the profiler enabled when the project you're trying to run was compiled? Note that this isn't the case if you installed Gazebo libraries from binaries, for example. You need to compile the project from source with the <code>ENABLE_PROFILER</code> variable set.</li>
<li>Are you using the correct port number in the upper left corner <code>Connection Addresss: ws://127.0.0.1:1500/rmt</code>? Running <code>gz sim -v 4</code> will show the port number in use near the top of the outputted text. The port number will be printed out if the profiler is enabled. <div class="fragment"><div class="line">[Dbg] [RemoteryProfilerImpl.cc:187] Starting gz-common profiler impl: Remotery (port: 1500)</div>
</div><!-- fragment --></li>
<li>Are you running the program in a separate terminal? The profiler only establishes connection if there is a program running and being actively profiled.</li>
<li>If you want to use a different port, configure the environment variable <code>RMT_PORT</code> by running the following in terminal, and update the web viewer port in your browser accordingly (see 2 above) <div class="fragment"><div class="line">export RMT_PORT=1500</div>
</div><!-- fragment --></li>
</ol>
<h2><a class="anchor" id="autotoc_md38"></a>
Using the Profiler</h2>
<p>The profiler is used through a series of macros.</p>
<p>The two primary ways of profiling a section of code are to either use a matched pair of <code>GZ_PROFILE_BEGIN</code> and <code>GZ_PROFILE_END</code> macros, or to use a single RAII-style macro <code>GZ_PROFILE</code>. The RAII style will stop measuring once the scope that the macro was invoked in is left.</p>
<p>Using begin/end:</p>
<div class="fragment"><div class="line"><span class="comment">// An example of using start/stop profiling.</span></div>
<div class="line"><a class="code hl_define" href="Profiler_8hh.html#a276096ba06de0b82b56487c3827e6509">GZ_PROFILE_BEGIN</a>(<span class="stringliteral">&quot;a&quot;</span>);</div>
<div class="line"><a class="code hl_functionRef" href="http://en.cppreference.com/w/cpp/thread/sleep_for.html">std::this_thread::sleep_for</a>(<a class="code hl_classRef" href="http://en.cppreference.com/w/cpp/chrono/duration.html">std::chrono::milliseconds</a>(2));</div>
<div class="line"><a class="code hl_define" href="Profiler_8hh.html#a4322ac431e2594d40cd21dce8ec2595b">GZ_PROFILE_END</a>();</div>
</div><!-- fragment --><p>Using RAII-style:</p>
<div class="fragment"><div class="line">{</div>
<div class="line">  <span class="comment">// An example of using scope-based profiling.</span></div>
<div class="line">  <a class="code hl_define" href="Profiler_8hh.html#a3fb61457508d9f964278538e2708dfda">GZ_PROFILE</a>(<span class="stringliteral">&quot;a&quot;</span>);</div>
<div class="line">  <a class="code hl_functionRef" href="http://en.cppreference.com/w/cpp/thread/sleep_for.html">std::this_thread::sleep_for</a>(<a class="code hl_classRef" href="http://en.cppreference.com/w/cpp/chrono/duration.html">std::chrono::milliseconds</a>(2));</div>
<div class="line">}</div>
</div><!-- fragment --><p>Additionally, each thread can be given a name for easy reference in the UI:</p>
<div class="fragment"><div class="line"><a class="code hl_define" href="Profiler_8hh.html#a969e457aa69134b1852732ad1b7695b3">GZ_PROFILE_THREAD_NAME</a>(<span class="stringliteral">&quot;main&quot;</span>);</div>
<div class="line"><a class="code hl_define" href="Profiler_8hh.html#a969e457aa69134b1852732ad1b7695b3">GZ_PROFILE_THREAD_NAME</a>(<span class="stringliteral">&quot;physics&quot;</span>);</div>
<div class="line"><a class="code hl_define" href="Profiler_8hh.html#a969e457aa69134b1852732ad1b7695b3">GZ_PROFILE_THREAD_NAME</a>(<span class="stringliteral">&quot;gui&quot;</span>);</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md39"></a>
Configuring the Profiler</h2>
<p>Specific profiler implementations may have further configuration options available.</p>
<h3><a class="anchor" id="autotoc_md40"></a>
Configuring Remotery</h3>
<p>Remotery can additionally be configured via environment variables. Most users should not need to change these for their applications.</p>
<ul>
<li><code>RMT_PORT</code>: Port to listen for incoming connections on.</li>
<li><code>RMT_QUEUE_SIZE</code>: Size of the internal message queues</li>
<li><code>RMT_MSGS_PER_UPDATE</code>: Upper limit on messages consumed per loop</li>
<li><code>RMT_SLEEP_BETWEEN_UPDATES</code>: Controls profile server update rate.</li>
</ul>
<p>These directly set the corresponding parameters in the <code>rmtSettings</code> structure. For more information, consult the <a href="https://github.com/Celtoys/Remotery/blob/8c3923a04493cd1cb3d21cfdb8ad6fb21b394b96/lib/Remotery.h#L354">Remotery source</a> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
      </div>
    </main>
  </div>
</body>
