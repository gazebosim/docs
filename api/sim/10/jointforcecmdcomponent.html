<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=9"/>
    <meta name="keywords" content="Gazebo Sim">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Gazebo Sim: Case Study: Using the JointForceCmd Component</title>
    <script type="text/javascript" src="https://gazebosim.org/assets/doxygen/dynsections.js"></script>
    <script type="text/javascript" src="jquery.js"></script>
    <link rel="icon" type="image/x-icon" href="https://gazebosim.org/assets/icon/favicon.ico">
    <link href='http://fonts.googleapis.com/css?family=Roboto:400,300,100,500,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.deep_orange-blue.min.css">
    <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>
    <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"> </script>
    <link href="https://gazebosim.org/assets/doxygen/doxygen.css" rel="stylesheet" type="text/css">
  </head>
    <script type="text/javascript">
      /* Replace all the "permalink" &#9670;&nbsp; icons with a unicode link
        symbol.*/
      $(document).ready(function() {
        var elems = document.getElementsByClassName("permalink");
        for (var i = 0; i < elems.length; ++i) {
          elems[i].firstChild.innerHTML="&#x1f517;";
          elems[i].firstChild.style.fontSize="18px";
        }
      });
    </script>
  </head>
<body>
  <div class="mdl-layout mdl-js-layout mdl-layout--fixed-drawer">
    <div class="mdl-layout__drawer mdl-color--grey-100 mdl-color-text--blue-grey-50">
      <header class="mdl-color--grey-100">
        <a href="index.html"><img width="60px" src="https://gazebosim.org/assets/doxygen/gazebo_logo.svg"/></a>
        <h1 class="project_title">Gazebo Sim</h1>
        <h2>API Reference</h2>
        <div class="version">
        10.0.0
        </div>
      </header>
      <!-- NOTE: If you add a link to a doxygen generated page, then make
                 sure to update the required_html_fils list in
                 GzCreateDocs.cmake -->
      <nav class="gz-navigation mdl-navigation">
        <a class="mdl-navigation__link" href="tutorials.html">
          <i class="mdl-color-text--grey-400 material-icons"
             role="presentation">insert_drive_file</i>Tutorials</a>
        <a id="class_menu" class="mdl-navigation__link" href="#">
          <i class="mdl-color-text--grey-400 material-icons"
             role="presentation">library_books</i>Classes</a>
        <a id="namespaces_menu"class="mdl-navigation__link" href="#">
          <i class="mdl-color-text--grey-400 material-icons"
             role="presentation">toc</i>Namespaces</a>
        <a class="mdl-navigation__link" href="files.html">
          <i class="mdl-color-text--grey-400 material-icons"
             role="presentation">insert_drive_file</i>Files</a>
        <a class="mdl-navigation__link" target="_blank"
           href="http://gazebosim.org">
          <i class="mdl-color-text--grey-400 material-icons"
             role="presentation">launch</i>Gazebo Website</a>
      </nav>
      <!-- classes sub menu -->
      <ul for="class_menu" class="mdl-menu mdl-menu--bottom-left mdl-js-menu mdl-js-ripple-effect mdl-navigation">
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link" href="classes.html">Index</a>
        </li>
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link"
            href="annotated.html">List</a>
        </li>
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link"
             href="hierarchy.html">Hierarchy</a>
        </li>
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link"
             href="functions.html">Members: All</a>
        </li>
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link"
             href="functions_func.html">Members: Functions</a>
        </li>
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link"
             href="functions_vars.html">Members: Variables</a>
        </li>
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link"
             href="functions_type.html">Members: Typedefs</a>
        </li>
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link"
             href="functions_enum.html">Members: Enumerations</a>
        </li>
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link"
             href="functions_eval.html">Members: Enumerator</a>
        </li>
      </ul>
      <!-- namespaces sub menu -->
      <ul for="namespaces_menu" class="mdl-menu mdl-menu--bottom-left mdl-js-menu mdl-js-ripple-effect mdl-navigation">
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link"
            href="namespaces.html">List</a>
        </li>
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link"
            href="namespacemembers.html">Members</a>
        </li>
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link"
            href="namespacemembers_func.html">Functions</a>
        </li>
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link"
            href="namespacemembers_type.html">Typedefs</a>
        </li>
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link"
            href="namespacemembers_vars.html">Variables</a>
        </li>
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link"
            href="namespacemembers_enum.html">Enumerations</a>
        </li>
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link"
            href="namespacemembers_eval.html">Enumerator</a>
        </li>
      </ul>
    </div>
    <main class="mdl-layout__content mdl-color--white">
    <div id="top">
<!-- Generated by Doxygen 1.9.8 -->
</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">Case Study: Using the JointForceCmd Component</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>We will show how to use one of the components, <a class="el" href="namespacegz_1_1sim_1_1components.html#acb1fa80d3ae07408b4bd1efbeedaef15">gz::sim::components::JointForceCmd</a>, in a system. This component allows us to set the force command on a joint.</p>
<p>Programmatic usage of this component can be found in the source code for systems and integration tests, such as the <a href="https://github.com/gazebosim/gz-sim/blob/gz-sim10/test/integration/joint.cc">joint integration test</a>, the <a class="el" href="classgz_1_1sim_1_1systems_1_1ApplyJointForce.html">gz::sim::systems::ApplyJointForce</a> system (<a href="https://github.com/gazebosim/gz-sim/tree/gz-sim10/src/systems/apply_joint_force">source code</a>), and others.</p>
<p>The corresponding world SDF is <a href="https://github.com/gazebosim/gz-sim/blob/gz-sim10/examples/worlds/apply_joint_force.sdf"><code>apply_joint_force.sdf</code></a>, which you can look at in Gazebo:</p>
<div class="fragment"><div class="line">gz sim apply_joint_force.sdf</div>
</div><!-- fragment --><p>We will walk through the relevant lines of source code in <code>ApplyJointForce</code> that interact with <code>JointForceCmd</code>.</p>
<h3><a class="anchor" id="find-the-entity-of-interest"></a>
Find the entity of interest</h3>
<p>First, we will need access to an entity, the <a class="el" href="classgz_1_1sim_1_1Joint.html">gz::sim::Joint</a> entity in this case. It is declared as a member variable:</p>
<div class="fragment"><div class="line">  <span class="keyword">public</span>: Entity jointEntity;</div>
</div><!-- fragment --><p>An entity may have been created at the time the world is loaded, or you may create an entity at runtime if it does not exist yet. For joints, most likely they were defined in the SDF file that specifies the world, and all we have to do at runtime is to look for the joint by its name.</p>
<p><code>ApplyJointForce</code> happens to be a system meant to be specified under <code>&lt;model&gt;</code> in the SDF, so at the time <code>Configure()</code> is called, it has access to a model entity from which we can extract a gz::sim::Model:</p>
<div class="fragment"><div class="line">  <span class="keyword">public</span>: Model model{kNullEntity};</div>
</div><!-- fragment --> <div class="fragment"><div class="line"><span class="keywordtype">void</span> ApplyJointForce::Configure(<span class="keyword">const</span> Entity &amp;_entity,</div>
<div class="line">    <span class="keyword">const</span> <a class="code hl_classRef" href="http://en.cppreference.com/w/cpp/memory/shared_ptr.html">std::shared_ptr&lt;const sdf::Element&gt;</a> &amp;_sdf,</div>
<div class="line">    EntityComponentManager &amp;_ecm,</div>
<div class="line">    EventManager &amp;<span class="comment">/*_eventMgr*/</span>)</div>
<div class="line">{</div>
<div class="line">  this-&gt;dataPtr-&gt;model = Model(_entity);</div>
</div><!-- fragment --><p>Using the Model object, we can find the joint by its name, when <code>PreUpdate()</code> is called. That gives us a Joint entity:</p>
<div class="fragment"><div class="line">  <span class="keywordflow">if</span> (this-&gt;dataPtr-&gt;jointEntity == kNullEntity)</div>
<div class="line">  {</div>
<div class="line">    this-&gt;dataPtr-&gt;jointEntity =</div>
<div class="line">        this-&gt;dataPtr-&gt;model.JointByName(_ecm, this-&gt;dataPtr-&gt;jointName);</div>
<div class="line">  }</div>
</div><!-- fragment --><h3><a class="anchor" id="modify-the-component"></a>
Modify the component</h3>
<p>Once we have the handle to an entity, we can modify components associated with it. A component may have been created at the time the world is loaded, or you may create a component at runtime if it does not exist yet.</p>
<p>In this case, we use the joint entity found above to look for and modify its <code>JointForceCmd</code> component. This will apply a force command to the joint.</p>
<p>In <code>PreUpdate()</code>, look for the component. If it does not exist yet, create it, setting its default value to <code>{0.0}</code> (which means, in this particular case, a 1-element <code><a class="elRef" href="http://en.cppreference.com/w/cpp/container/vector.html">std::vector</a>&lt;double&gt;</code> with value 0.0 in its only element):</p>
<div class="fragment"><div class="line">  <span class="keyword">auto</span> force = _ecm.ComponentDefault&lt;components::JointForceCmd&gt;(</div>
<div class="line">      this-&gt;dataPtr-&gt;jointEntity, {0.0});</div>
</div><!-- fragment --><p>Now modify the value stored in the component:</p>
<div class="fragment"><div class="line">  force-&gt;Data()[0] += this-&gt;dataPtr-&gt;jointForceCmd;</div>
</div><!-- fragment --><p>where the scalar joint force command is declared as a member variable:</p>
<div class="fragment"><div class="line">  <span class="keyword">public</span>: <span class="keywordtype">double</span> jointForceCmd;</div>
</div><!-- fragment --><p>and a callback function allows the user to specify a force on a topic:</p>
<div class="fragment"><div class="line">  <span class="keyword">auto</span> topic = transport::TopicUtils::AsValidTopic(<span class="stringliteral">&quot;/model/&quot;</span> +</div>
<div class="line">      this-&gt;dataPtr-&gt;model.Name(_ecm) + <span class="stringliteral">&quot;/joint/&quot;</span> + this-&gt;dataPtr-&gt;jointName +</div>
<div class="line">      <span class="stringliteral">&quot;/cmd_force&quot;</span>);</div>
</div><!-- fragment --> <div class="fragment"><div class="line">  this-&gt;dataPtr-&gt;node.Subscribe(topic, &amp;ApplyJointForcePrivate::OnCmdForce,</div>
<div class="line">                                this-&gt;dataPtr.get());</div>
</div><!-- fragment --> <div class="fragment"><div class="line"><span class="keywordtype">void</span> ApplyJointForcePrivate::OnCmdForce(<span class="keyword">const</span> msgs::Double &amp;_msg)</div>
<div class="line">{</div>
<div class="line">  <a class="code hl_classRef" href="http://en.cppreference.com/w/cpp/thread/lock_guard.html">std::lock_guard&lt;std::mutex&gt;</a> lock(this-&gt;jointForceCmdMutex);</div>
<div class="line">  this-&gt;jointForceCmd = _msg.data();</div>
<div class="line">}</div>
</div><!-- fragment --><p>You can test this by issuing a force command to the topic:</p>
<div class="fragment"><div class="line">gz topic -t /model/joint_force_example/joint/j1/cmd_force \</div>
<div class="line">  -m gz.msgs.Double -p &#39;data: 1.0&#39;</div>
</div><!-- fragment --><p> This should move the model that the joint is attached to. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
      </div>
    </main>
  </div>
</body>
