<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=9"/>
    <meta name="keywords" content="Gazebo Sim">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Gazebo Sim: Distributed Simulation</title>
    <script type="text/javascript" src="https://gazebosim.org/assets/doxygen/dynsections.js"></script>
    <script type="text/javascript" src="jquery.js"></script>
    <link rel="icon" type="image/x-icon" href="https://gazebosim.org/assets/icon/favicon.ico">
    <link href='http://fonts.googleapis.com/css?family=Roboto:400,300,100,500,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.deep_orange-blue.min.css">
    <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>
    <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"> </script>
    <link href="https://gazebosim.org/assets/doxygen/doxygen.css" rel="stylesheet" type="text/css">
  </head>
    <script type="text/javascript">
      /* Replace all the "permalink" &#9670;&nbsp; icons with a unicode link
        symbol.*/
      $(document).ready(function() {
        var elems = document.getElementsByClassName("permalink");
        for (var i = 0; i < elems.length; ++i) {
          elems[i].firstChild.innerHTML="&#x1f517;";
          elems[i].firstChild.style.fontSize="18px";
        }
      });
    </script>
  </head>
<body>
  <div class="mdl-layout mdl-js-layout mdl-layout--fixed-drawer">
    <div class="mdl-layout__drawer mdl-color--grey-100 mdl-color-text--blue-grey-50">
      <header class="mdl-color--grey-100">
        <a href="index.html"><img width="60px" src="https://gazebosim.org/assets/doxygen/gazebo_logo.svg"/></a>
        <h1 class="project_title">Gazebo Sim</h1>
        <h2>API Reference</h2>
        <div class="version">
        9.4.0
        </div>
      </header>
      <!-- NOTE: If you add a link to a doxygen generated page, then make
                 sure to update the required_html_fils list in
                 GzCreateDocs.cmake -->
      <nav class="gz-navigation mdl-navigation">
        <a class="mdl-navigation__link" href="tutorials.html">
          <i class="mdl-color-text--grey-400 material-icons"
             role="presentation">insert_drive_file</i>Tutorials</a>
        <a id="class_menu" class="mdl-navigation__link" href="#">
          <i class="mdl-color-text--grey-400 material-icons"
             role="presentation">library_books</i>Classes</a>
        <a id="namespaces_menu"class="mdl-navigation__link" href="#">
          <i class="mdl-color-text--grey-400 material-icons"
             role="presentation">toc</i>Namespaces</a>
        <a class="mdl-navigation__link" href="files.html">
          <i class="mdl-color-text--grey-400 material-icons"
             role="presentation">insert_drive_file</i>Files</a>
        <a class="mdl-navigation__link" target="_blank"
           href="http://gazebosim.org">
          <i class="mdl-color-text--grey-400 material-icons"
             role="presentation">launch</i>Gazebo Website</a>
      </nav>
      <!-- classes sub menu -->
      <ul for="class_menu" class="mdl-menu mdl-menu--bottom-left mdl-js-menu mdl-js-ripple-effect mdl-navigation">
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link" href="classes.html">Index</a>
        </li>
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link"
            href="annotated.html">List</a>
        </li>
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link"
             href="hierarchy.html">Hierarchy</a>
        </li>
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link"
             href="functions.html">Members: All</a>
        </li>
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link"
             href="functions_func.html">Members: Functions</a>
        </li>
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link"
             href="functions_vars.html">Members: Variables</a>
        </li>
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link"
             href="functions_type.html">Members: Typedefs</a>
        </li>
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link"
             href="functions_enum.html">Members: Enumerations</a>
        </li>
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link"
             href="functions_eval.html">Members: Enumerator</a>
        </li>
      </ul>
      <!-- namespaces sub menu -->
      <ul for="namespaces_menu" class="mdl-menu mdl-menu--bottom-left mdl-js-menu mdl-js-ripple-effect mdl-navigation">
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link"
            href="namespaces.html">List</a>
        </li>
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link"
            href="namespacemembers.html">Members</a>
        </li>
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link"
            href="namespacemembers_func.html">Functions</a>
        </li>
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link"
            href="namespacemembers_type.html">Typedefs</a>
        </li>
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link"
            href="namespacemembers_vars.html">Variables</a>
        </li>
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link"
            href="namespacemembers_enum.html">Enumerations</a>
        </li>
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link"
            href="namespacemembers_eval.html">Enumerator</a>
        </li>
      </ul>
    </div>
    <main class="mdl-layout__content mdl-color--white">
    <div id="top">
<!-- Generated by Doxygen 1.9.8 -->
</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">Distributed Simulation</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h2><a class="anchor" id="goals"></a>
Goals</h2>
<ul>
<li>Simulation can be distributed among 1 or more processes</li>
<li>These processes can be running on the same machine or different ones</li>
<li>These processes must be kept in sync</li>
<li>Results can't be interpolated or missed</li>
<li>We should reduce the amount of duplicate effort across processes</li>
</ul>
<h2><a class="anchor" id="high-level-design"></a>
High-Level design</h2>
<p>Each <code>gz sim</code> instance has the ability to run with the <code>--network-role</code> flag. When the flag is present, the instance attempts to join a distributed simulation environment by utilizing <code>gz-transport</code>. gz-transport is used to register and track available peers, as well as synchronize clock and state among multiple distributed environment participants.</p>
<p>Distributed environment participants can take one of the following roles.</p>
<ul>
<li>Primary - responsible for distributing work and synchronizing clocks among the other participants</li>
<li>Secondary - responsible for receiving work from the primary instance and executing physics and sensor simulation. Results are reported back to the Primary.</li>
</ul>
<p>The distribution of simulation work utilizes the concept of performers in order to set where physics simulation will occur. A performer is an additional annotation in an SDF file which marks each model that will be a performer. There can be 0 to N performers being simulated at an instance at a time. Each level can only be simulated by one secondary at a time, so performers in the same level are always in the same instance. If there are more levels active than instances, multiple levels will be allocated to each secondary.</p>
<h2><a class="anchor" id="assumptions"></a>
Assumptions</h2>
<ul>
<li>When executing in a distributed environment, each <code>gz sim</code> instance only has one <code>SimulationRunner</code> instance, which means that instance is incapable of simulating multiple worlds.</li>
<li>Distributed lockstep - all simulation runners step at the same time. If a particular instance is running slower than the rest, it will have an impact on the total simulation throughput.</li>
<li>Fixed runners - all simulation runners have to be defined ahead of time. If a runner joins or leaves the graph after simulation has started, simulation will terminate.</li>
</ul>
<h2><a class="anchor" id="execution-flow"></a>
Execution flow</h2>
<h3><a class="anchor" id="configuration-and-launch"></a>
Configuration and launch</h3>
<p>Multiple <code>gz sim</code> executables are started on the same local area network, each with the <code>--distributed</code> flag set.</p>
<h4><a class="anchor" id="command-line-options"></a>
Command line options</h4>
<p>The primary instance will read several command line options to dictate its behavior.</p>
<ul>
<li><b>&ndash;network-role=primary</b> - Dictates that the role of this participant is a Primary. Capitalization of "primary" is not important.</li>
<li><b>&ndash;network-secondaries=<code>&lt;N&gt;</code></b> - The number of secondaries expected to join. Simulation will not begin until <b>N</b> secondaries have been discovered.</li>
</ul>
<p>The secondary instances will only read the role command line option</p>
<ul>
<li><b>&ndash;network-role=secondary</b> - Dictates that the role of this participant is a Secondary. Capitalization of "secondary" is not important.</li>
</ul>
<h3><a class="anchor" id="discovery"></a>
Discovery</h3>
<p>Once the <code>gz sim</code> instance is started, it will begin a process of discovering peers in the network. Each peer will send an announcement in the <code>/announce</code> topic when it joins or leaves the network, and also periodically sends a heartbeat on <code>/heartbeat</code>.</p>
<p>Simulation is allowed to begin once each secondary has discovered the primary and the primary has discovered the correct number of secondaries.</p>
<p>If at any time the primary or any secondaries leave the network, either intentionally (through shutdown) or unintentionally (segfault or network issues), then the rest of the simulation graph will get a signal and shut down safely.</p>
<p>There are two possible signals that can be received. The first is an intentional announcement from a network peer that it is shutting down. The second is when a peer fails to receive a heartbeat from another peer after a specified duration. Both of these signals will cause the termination of the simulation.</p>
<h3><a class="anchor" id="distribution"></a>
Distribution</h3>
<p>After discovery, the <code>NetworkManager</code> works on the initial distribution of performers across the network graph according to the levels they're in. If there are more performers than secondaries, then some secondaries will receive multiple performers. On the other hand, if performers are located in less levels than secondaries, some secondaries will be left idle.</p>
<p>As simulation proceeds and performers move across levels, their affinities will be updated as part of the message sent on the <code>/step</code> topic in order to avoid duplicate levels across secondaries. The primary, on the other hand, keeps all performers loaded, but performs no physics simulation.</p>
<h3><a class="anchor" id="stepping"></a>
Stepping</h3>
<p>Stepping happens in 2 stages: the primary update and the secondaries update, according to the diagram below:</p>
<p><img src="https://raw.githubusercontent.com/gazebosim/gz-sim/main/tutorials/files/distributed_step.png" alt="" class="inline"/></p>
<ol type="1">
<li>The primary publishes a <code>SimulationStep</code> message on the <code>/step</code> topic, containing:<ul>
<li>The current sim time, iteration, step size and paused state.</li>
<li>The latest secondary-to-performer affinity changes.</li>
<li><b>Upcoming</b>: The updated state of all performers which are changing secondaries.</li>
</ul>
</li>
<li>Each secondary receives the step message, and:<ul>
<li>Loads / unloads performers according to the received affinities</li>
<li>Runs one simulation update iteration</li>
<li>Then publishes its updated performer states on the <code>/step_ack</code> topic.</li>
</ul>
</li>
<li>The primary waits until it gets step acks from all secondaries.</li>
<li>The primary runs a step update:<ul>
<li>Update its state with the states received from secondaries.</li>
<li>The <code>LevelManager</code> checks for level changes according to these new states</li>
<li>The <code>SceneBroadcaster</code> plugin publishes an updated scene to the GUI for any level changes.</li>
</ul>
</li>
<li>The primary initiates a new iteration.</li>
</ol>
<h3><a class="anchor" id="interaction"></a>
Interaction</h3>
<p>All interaction with the simulation environment should happen via the same topics that are used for non-distributed simulation, which should all be provided by the primary. Therefore, play/pause and GUI functionality all interact with the simulation primary instance, which in turn propagates the commands to the secondaries. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
      </div>
    </main>
  </div>
</body>
