<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=9"/>
    <meta name="keywords" content="Gazebo Sim">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Gazebo Sim: Blender Python script for programmatic mesh distortion</title>
    <script type="text/javascript" src="https://gazebosim.org/assets/doxygen/dynsections.js"></script>
    <script type="text/javascript" src="jquery.js"></script>
    <link rel="icon" type="image/x-icon" href="https://gazebosim.org/assets/icon/favicon.ico">
    <link href='http://fonts.googleapis.com/css?family=Roboto:400,300,100,500,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.deep_orange-blue.min.css">
    <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>
    <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"> </script>
    <link href="https://gazebosim.org/assets/doxygen/doxygen.css" rel="stylesheet" type="text/css">
  </head>
    <script type="text/javascript">
      /* Replace all the "permalink" &#9670;&nbsp; icons with a unicode link
        symbol.*/
      $(document).ready(function() {
        var elems = document.getElementsByClassName("permalink");
        for (var i = 0; i < elems.length; ++i) {
          elems[i].firstChild.innerHTML="&#x1f517;";
          elems[i].firstChild.style.fontSize="18px";
        }
      });
    </script>
  </head>
<body>
  <div class="mdl-layout mdl-js-layout mdl-layout--fixed-drawer">
    <div class="mdl-layout__drawer mdl-color--grey-100 mdl-color-text--blue-grey-50">
      <header class="mdl-color--grey-100">
        <a href="index.html"><img width="60px" src="https://gazebosim.org/assets/doxygen/gazebo_logo.svg"/></a>
        <h1 class="project_title">Gazebo Sim</h1>
        <h2>API Reference</h2>
        <div class="version">
        8.5.0
        </div>
      </header>
      <!-- NOTE: If you add a link to a doxygen generated page, then make
                 sure to update the required_html_fils list in
                 GzCreateDocs.cmake -->
      <nav class="gz-navigation mdl-navigation">
        <a class="mdl-navigation__link" href="tutorials.html">
          <i class="mdl-color-text--grey-400 material-icons"
             role="presentation">insert_drive_file</i>Tutorials</a>
        <a id="class_menu" class="mdl-navigation__link" href="#">
          <i class="mdl-color-text--grey-400 material-icons"
             role="presentation">library_books</i>Classes</a>
        <a id="namespaces_menu"class="mdl-navigation__link" href="#">
          <i class="mdl-color-text--grey-400 material-icons"
             role="presentation">toc</i>Namespaces</a>
        <a class="mdl-navigation__link" href="files.html">
          <i class="mdl-color-text--grey-400 material-icons"
             role="presentation">insert_drive_file</i>Files</a>
        <a class="mdl-navigation__link" target="_blank"
           href="http://gazebosim.org">
          <i class="mdl-color-text--grey-400 material-icons"
             role="presentation">launch</i>Gazebo Website</a>
      </nav>
      <!-- classes sub menu -->
      <ul for="class_menu" class="mdl-menu mdl-menu--bottom-left mdl-js-menu mdl-js-ripple-effect mdl-navigation">
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link" href="classes.html">Index</a>
        </li>
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link"
            href="annotated.html">List</a>
        </li>
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link"
             href="hierarchy.html">Hierarchy</a>
        </li>
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link"
             href="functions.html">Members: All</a>
        </li>
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link"
             href="functions_func.html">Members: Functions</a>
        </li>
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link"
             href="functions_vars.html">Members: Variables</a>
        </li>
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link"
             href="functions_type.html">Members: Typedefs</a>
        </li>
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link"
             href="functions_enum.html">Members: Enumerations</a>
        </li>
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link"
             href="functions_eval.html">Members: Enumerator</a>
        </li>
      </ul>
      <!-- namespaces sub menu -->
      <ul for="namespaces_menu" class="mdl-menu mdl-menu--bottom-left mdl-js-menu mdl-js-ripple-effect mdl-navigation">
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link"
            href="namespaces.html">List</a>
        </li>
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link"
            href="namespacemembers.html">Members</a>
        </li>
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link"
            href="namespacemembers_func.html">Functions</a>
        </li>
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link"
            href="namespacemembers_type.html">Typedefs</a>
        </li>
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link"
            href="namespacemembers_vars.html">Variables</a>
        </li>
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link"
            href="namespacemembers_enum.html">Enumerations</a>
        </li>
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link"
            href="namespacemembers_eval.html">Enumerator</a>
        </li>
      </ul>
    </div>
    <main class="mdl-layout__content mdl-color--white">
    <div id="top">
<!-- Generated by Doxygen 1.9.1 -->
</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Blender Python script for programmatic mesh distortion </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Programmatic distortions of 3D models allows us to create numerically controlled deformations on an object in batches. This can be used to generate sets of similar objects to test the generalization of perception algorithms, underwater manipulation of naturally biofouled or deformed objects, and in other applications.</p>
<p>One way to programmatically distort models is to use Blender Python scripting. Blender is a free open source 3D modeling software used by professional artists for games and films. It offers a Python API for most things available in its GUI.</p>
<h2><a class="anchor" id="autotoc_md36"></a>
Prerequisites</h2>
<p>These instructions have been tested in <a href="https://www.blender.org/">Blender</a> 2.92, 3.0.1 and 3.2. Version 2.8x and above have a revamped user interface from previous versions. The version in packaging managers such as <code>apt-get</code> may be older. In that case, install manually as needed. These instructions may work in newer versions. If newer versions do not work for you, Blender 2.92 can be found <a href="https://download.blender.org/release/Blender2.92">here</a>.</p>
<h2><a class="anchor" id="autotoc_md37"></a>
Usage</h2>
<p>Locate or download the Blender Python <a href="https://github.com/gazebosim/gz-sim/blob/gz-sim8/examples/scripts/blender/distort_mesh.py">script</a>.</p>
<p>Launch the Blender GUI.</p>
<p>Helpful tip for Blender Python development: To show Python API in the tooltips when the cursor is hovered over a button or field, go to Edit &gt; Preferences, Interface tab, Display group, check Python Tooltips.</p>
<h3><a class="anchor" id="autotoc_md38"></a>
Locate model file and mesh name</h3>
<p>Before we run the script, we need to locate the path of the 3D model file and find the name of the part in the actual model file. These will be passed as parameters to the script.</p>
<ol type="1">
<li><p class="startli">We will use the <a href="https://app.gazebosim.org/OpenRobotics/fuel/models/Coke">Coke</a> model as an example.</p>
<p class="startli">The rest of the tutorial will assume that you have downloaded the model into a directory called <code>models</code>, and the OBJ file is located at <code>models/Coke/meshes/coke.obj</code>.</p>
</li>
<li><p class="startli">Open or import the 3D model file of the object you want to distort.</p>
<p class="startli">In the upper-left corner, File &gt; Import. Navigate to the mesh file you want.</p>
<p class="startli">Choose Transform while importing: Z Up, X Forward.</p>
</li>
<li><p class="startli">Look for the mesh name in the model.</p>
<p class="startli">You can find this in the View Layer list in the upper-right panel.</p>
<p class="startli">If the model has multiple meshes, you will need to merge the parts, so that the entire model is distorted, or choose the part that you wish to distort.</p>
</li>
</ol>
<p>Tip: To view the textured object in the viewport, click on the globe icon in the upper right of the viewport, which is for Viewport Shading: Material Preview.</p>
<p>If the texture is not loading correctly for you, check that you have the entire folder for the object, which includes the <code>meshes</code> and <code>materials</code> directories.</p>
<h3><a class="anchor" id="autotoc_md39"></a>
Tweak the model (optional)</h3>
<p>Note that depending on how the polygons are arranged on a mesh, the results of the distortion will differ. Advanced users may choose to split up the polygons or otherwise change the polygon layout to get more even distortion results. This is a matter of trial and error until you are happy with the distortion result.</p>
<h3><a class="anchor" id="autotoc_md40"></a>
Run the script</h3>
<p>The script takes a few arguments. For the latest arguments, see the script itself.</p>
<ul>
<li><code>mesh_path</code>: Absolute path to the mesh file</li>
<li><code>object_prefix</code>: Name of the object in the Scene Collection panel in Blender, or the prefix of the name if it contains automatically generated suffixes like <code>.001</code>, <code>.002</code>, etc. Blender automatically appends numerical suffixes if the script is repeatedly run.</li>
<li><code>distort_extent</code>: A floating point number in the range of [0, 1]. This number may need tuning depending on the object model. If using <code>vert_rand</code> method, you may want to tune <code>VERT_RAND_MIN</code> and <code>VERT_RAND_MAX</code> to the model.</li>
<li><code>method</code>: A list of strings. Distortion operations, in order of desired execution.</li>
</ul>
<h4><a class="anchor" id="autotoc_md41"></a>
From shell command prompt</h4>
<p>Run the Blender executable in the background (<code>-b</code>), passing it the Python (<code>-P</code>) script file and custom arguments to the distortion script (arguments after <code>--</code>): </p><div class="fragment"><div class="line">blender -b -P distort_mesh.py -- &#39;/path/to/models/Coke/meshes/coke.obj&#39; &#39;LPCoke_Cube&#39; 0.005 &quot;[&#39;subdiv_mod&#39;, &#39;vert_rand&#39;, &#39;edge_subdiv&#39;]&quot;</div>
</div><!-- fragment --><p>Note that the list needs to be in quotes.</p>
<h4><a class="anchor" id="autotoc_md42"></a>
From Blender Scripting panel Python prompt</h4>
<p>At the top of Blender GUI, go to the Scripting tab. All commands will be executed in the Console panel in the middle-left of the screen.</p>
<p>Define the full path to the model file and the mesh name, which you found above. For example, the <code>Coke</code> model: </p><div class="fragment"><div class="line">file_path = &#39;/path/to/models/Coke/meshes/coke.obj&#39;</div>
<div class="line">object_prefix = &#39;LPCoke_Cube&#39;</div>
</div><!-- fragment --><p>Set optional arguments. If not specified, the default will be used. Make sure <code>method</code> is specified as a list in brackets, even if it contains only one element. </p><div class="fragment"><div class="line">distort_extent = 0.005</div>
<div class="line">method = [&#39;subdiv_mod&#39;, &#39;vert_rand&#39;, &#39;edge_subdiv&#39;]</div>
</div><!-- fragment --><p>Put the args into the input array: </p><div class="fragment"><div class="line">import sys</div>
<div class="line">sys.argv = [file_path, object_prefix, distort_extent, method]</div>
</div><!-- fragment --><p>Run the script, replacing its path with the one on your machine: </p><div class="fragment"><div class="line">exec(open(&#39;/path/to/distort_mesh.py&#39;).read());</div>
</div><!-- fragment --><p>This will execute the script with the command line arguments defined in <code>sys.argv</code> and export the result to file.</p>
<h2><a class="anchor" id="autotoc_md43"></a>
Example results</h2>
<h3><a class="anchor" id="autotoc_md44"></a>
Coke object distorted at increased extents</h3>
<div class="image">
<img src="Coke_distort_less.png" alt="" width="80%"/>
<div class="caption">
Coke distorted less</div></div>
<div class="image">
<img src="Coke_distort_more.png" alt="" width="80%"/>
<div class="caption">
Coke distorted more</div></div>
<div class="image">
<img src="Coke_distort_most.png" alt="" width="80%"/>
<div class="caption">
Coke distorted most</div></div>
<h3><a class="anchor" id="autotoc_md45"></a>
Coke Can object distorted at increased extents</h3>
<p>This example shows the <a href="https://app.gazebosim.org/OpenRobotics/fuel/models/Coke%20Can">Coke Can</a>, which we first converted to OBJ format and then distorted.</p>
<p>Wireframe view:</p>
<div class="image">
<img src="Coke_Can_distort_less.png" alt="" width="80%"/>
<div class="caption">
Coke_Can distorted less</div></div>
 <div class="image">
<img src="Coke_Can_distort_more.png" alt="" width="80%"/>
<div class="caption">
Coke_Can distorted more</div></div>
 <div class="image">
<img src="Coke_Can_distort_most.png" alt="" width="80%"/>
<div class="caption">
Coke_Can distorted most</div></div>
<p>Textured view:</p>
<div class="image">
<img src="Coke_Can_distort_less_textured.png" alt="" width="80%"/>
<div class="caption">
Coke_Can distorted less</div></div>
 <div class="image">
<img src="Coke_Can_distort_more_textured.png" alt="" width="80%"/>
<div class="caption">
Coke_Can distorted more</div></div>
 <div class="image">
<img src="Coke_Can_distort_most_textured.png" alt="" width="80%"/>
<div class="caption">
Coke_Can distorted most</div></div>
<h2><a class="anchor" id="autotoc_md46"></a>
To add a new distortion method to the script</h2>
<p>There are many ways in Blender to modify a mesh. The example methods in the script may not have everything you need.</p>
<p>To add a new distortion method to the script, follow these steps:</p><ol type="1">
<li><p class="startli">Experiment with the distortion method you want, manually in Blender, until you know the exact steps to reproduce a desired result.</p>
<p class="startli">Find the Python API for the fields and buttons in the Blender user interface.</p>
<p class="startli">You can find the Blender Python API name by hovering on most buttons, if you have Python Tooltips turned on in Edit &gt; Preferences.</p>
</li>
<li><p class="startli">In the Blender Python script, add a string parameter describing the distortion type to the <code>METHODS</code> list.</p>
<p class="startli">A descriptive name would be one that closely resembles the core essential function name in Blender.</p>
</li>
<li>Add a Python function to perform all the necessary steps programmatically, using the API you found above.</li>
<li>Following the existing pattern in the Python script, add an if-statement to call the new method.</li>
<li>Run it! Trial and error to make sure it works for different models. See troubleshoot section below.</li>
</ol>
<h2><a class="anchor" id="autotoc_md47"></a>
Troubleshoot</h2>
<h3><a class="anchor" id="autotoc_md48"></a>
Incorrect context</h3>
<p>Blender might complain about incorrect context. One cause is that the object you are trying to modify is not the "active" object.</p>
<p>(Note that this is different from the object being selected. An object can be selected, indicated by an orange outline, but not active, which would be indicated by a white outline.)</p>
<p>To make the object active, find the object programatically, then call </p><div class="fragment"><div class="line">bpy.context.view_layer.objects.active = obj</div>
</div><!-- fragment --><p>There are example calls in the Python script.</p>
<h2><a class="anchor" id="autotoc_md49"></a>
Tips</h2>
<ul>
<li><p class="startli">Collision geometry</p>
<p class="startli">When using the mesh with a physics engine, for example by way of an SDF file to be loaded into Gazebo, note that it is usually not a good idea to use the visual mesh for collision, because of the high polygon count. Typically, a simple primitive is used for collision, which makes computations much faster.</p>
<p class="startli">However, if the goal is to have mesh deformation affect physical interactions like manipulation, using a simple primitive would defeat the purpose. In that case, a good compromise is to optimize (for example, using the Decimate modifier in Blender) the visual mesh down to a fraction of its polygon count, and use the optimized mesh for collision. There will be mismatches between collision and visual geometry, but collision computations would be much faster.</p>
</li>
</ul>
<h2><a class="anchor" id="autotoc_md50"></a>
Known issues</h2>
<ul>
<li>Blender sometimes does not export the texture back to a COLLADA file correctly. Importing OBJ and exporting COLLADA works fine. </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
      </div>
    </main>
  </div>
</body>
