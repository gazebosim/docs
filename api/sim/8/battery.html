<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=9"/>
    <meta name="keywords" content="Gazebo Sim">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Gazebo Sim: Battery</title>
    <script type="text/javascript" src="https://gazebosim.org/assets/doxygen/dynsections.js"></script>
    <script type="text/javascript" src="jquery.js"></script>
    <link rel="icon" type="image/x-icon" href="https://gazebosim.org/assets/icon/favicon.ico">
    <link href='http://fonts.googleapis.com/css?family=Roboto:400,300,100,500,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.deep_orange-blue.min.css">
    <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>
    <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"> </script>
    <link href="https://gazebosim.org/assets/doxygen/doxygen.css" rel="stylesheet" type="text/css">
  </head>
    <script type="text/javascript">
      /* Replace all the "permalink" &#9670;&nbsp; icons with a unicode link
        symbol.*/
      $(document).ready(function() {
        var elems = document.getElementsByClassName("permalink");
        for (var i = 0; i < elems.length; ++i) {
          elems[i].firstChild.innerHTML="&#x1f517;";
          elems[i].firstChild.style.fontSize="18px";
        }
      });
    </script>
  </head>
<body>
  <div class="mdl-layout mdl-js-layout mdl-layout--fixed-drawer">
    <div class="mdl-layout__drawer mdl-color--grey-100 mdl-color-text--blue-grey-50">
      <header class="mdl-color--grey-100">
        <a href="index.html"><img width="60px" src="https://gazebosim.org/assets/doxygen/gazebo_logo.svg"/></a>
        <h1 class="project_title">Gazebo Sim</h1>
        <h2>API Reference</h2>
        <div class="version">
        8.6.0
        </div>
      </header>
      <!-- NOTE: If you add a link to a doxygen generated page, then make
                 sure to update the required_html_fils list in
                 GzCreateDocs.cmake -->
      <nav class="gz-navigation mdl-navigation">
        <a class="mdl-navigation__link" href="tutorials.html">
          <i class="mdl-color-text--grey-400 material-icons"
             role="presentation">insert_drive_file</i>Tutorials</a>
        <a id="class_menu" class="mdl-navigation__link" href="#">
          <i class="mdl-color-text--grey-400 material-icons"
             role="presentation">library_books</i>Classes</a>
        <a id="namespaces_menu"class="mdl-navigation__link" href="#">
          <i class="mdl-color-text--grey-400 material-icons"
             role="presentation">toc</i>Namespaces</a>
        <a class="mdl-navigation__link" href="files.html">
          <i class="mdl-color-text--grey-400 material-icons"
             role="presentation">insert_drive_file</i>Files</a>
        <a class="mdl-navigation__link" target="_blank"
           href="http://gazebosim.org">
          <i class="mdl-color-text--grey-400 material-icons"
             role="presentation">launch</i>Gazebo Website</a>
      </nav>
      <!-- classes sub menu -->
      <ul for="class_menu" class="mdl-menu mdl-menu--bottom-left mdl-js-menu mdl-js-ripple-effect mdl-navigation">
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link" href="classes.html">Index</a>
        </li>
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link"
            href="annotated.html">List</a>
        </li>
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link"
             href="hierarchy.html">Hierarchy</a>
        </li>
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link"
             href="functions.html">Members: All</a>
        </li>
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link"
             href="functions_func.html">Members: Functions</a>
        </li>
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link"
             href="functions_vars.html">Members: Variables</a>
        </li>
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link"
             href="functions_type.html">Members: Typedefs</a>
        </li>
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link"
             href="functions_enum.html">Members: Enumerations</a>
        </li>
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link"
             href="functions_eval.html">Members: Enumerator</a>
        </li>
      </ul>
      <!-- namespaces sub menu -->
      <ul for="namespaces_menu" class="mdl-menu mdl-menu--bottom-left mdl-js-menu mdl-js-ripple-effect mdl-navigation">
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link"
            href="namespaces.html">List</a>
        </li>
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link"
            href="namespacemembers.html">Members</a>
        </li>
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link"
            href="namespacemembers_func.html">Functions</a>
        </li>
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link"
            href="namespacemembers_type.html">Typedefs</a>
        </li>
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link"
            href="namespacemembers_vars.html">Variables</a>
        </li>
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link"
            href="namespacemembers_enum.html">Enumerations</a>
        </li>
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link"
            href="namespacemembers_eval.html">Enumerator</a>
        </li>
      </ul>
    </div>
    <main class="mdl-layout__content mdl-color--white">
    <div id="top">
<!-- Generated by Doxygen 1.9.1 -->
</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Battery </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The battery system keeps track of the battery charge on a robot model.</p>
<p>Currently, one battery per model is supported. When the battery drains completely, all joints of the corresponding model are turned off, meaning joint forces are set to 0.</p>
<p>All logic for battery consumption are encapsulated in a plugin.</p>
<h2><a class="anchor" id="autotoc_md26"></a>
A perfect battery</h2>
<p>An ideal battery has a constant voltage while discharging and no internal resistance. Here's a minimum example of a perfect battery that can be added to a model:</p>
<div class="fragment"><div class="line">&lt;<span class="keywordtype">model</span>&gt;</div>
<div class="line">  ...</div>
<div class="line">  &lt;<span class="keywordtype">plugin</span> <span class="keyword">filename</span>=<span class="stringliteral">&quot;gz-sim-linearbatteryplugin-system&quot;</span></div>
<div class="line">        <span class="keyword">name</span>=<span class="stringliteral">&quot;gz::sim::systems::LinearBatteryPlugin&quot;</span>&gt;</div>
<div class="line">        <span class="comment">&lt;!--Li-ion battery spec from LIR18650 datasheet--&gt;</span></div>
<div class="line">        &lt;<span class="keywordtype">battery_name</span>&gt;<span class="keyword">linear_battery</span>&lt;/<span class="keywordtype">battery_name</span>&gt;</div>
<div class="line">        &lt;<span class="keywordtype">voltage</span>&gt;4.2&lt;/<span class="keywordtype">voltage</span>&gt;</div>
<div class="line">        &lt;<span class="keywordtype">open_circuit_voltage_constant_coef</span>&gt;4.2&lt;/<span class="keywordtype">open_circuit_voltage_constant_coef</span>&gt;</div>
<div class="line">        &lt;<span class="keywordtype">open_circuit_voltage_linear_coef</span>&gt;-2.0&lt;/<span class="keywordtype">open_circuit_voltage_linear_coef</span>&gt;</div>
<div class="line">        &lt;<span class="keywordtype">initial_charge</span>&gt;2.5&lt;/<span class="keywordtype">initial_charge</span>&gt;</div>
<div class="line">        &lt;<span class="keywordtype">capacity</span>&gt;2.5 &lt;/<span class="keywordtype">capacity</span>&gt;</div>
<div class="line">        &lt;<span class="keywordtype">resistance</span>&gt;0.07&lt;/<span class="keywordtype">resistance</span>&gt;</div>
<div class="line">        &lt;<span class="keywordtype">smooth_current_tau</span>&gt;2.0&lt;/<span class="keywordtype">smooth_current_tau</span>&gt;</div>
<div class="line">        &lt;<span class="keywordtype">enable_recharge</span>&gt;<span class="keyword">false</span>&lt;/<span class="keywordtype">enable_recharge</span>&gt;</div>
<div class="line">        &lt;<span class="keywordtype">charging_time</span>&gt;3.0&lt;/<span class="keywordtype">charging_time</span>&gt;</div>
<div class="line">        &lt;<span class="keywordtype">soc_threshold</span>&gt;0.51&lt;/<span class="keywordtype">soc_threshold</span>&gt;</div>
<div class="line">        <span class="comment">&lt;!-- Consumer-specific --&gt;</span></div>
<div class="line">        &lt;<span class="keywordtype">power_load</span>&gt;2.1&lt;/<span class="keywordtype">power_load</span>&gt;</div>
<div class="line">        &lt;<span class="keywordtype">start_on_motion</span>&gt;<span class="keyword">true</span>&lt;/<span class="keywordtype">start_on_motion</span>&gt;</div>
<div class="line">      &lt;/<span class="keywordtype">plugin</span>&gt;</div>
<div class="line">  ...</div>
<div class="line">&lt;/<span class="keywordtype">model</span>&gt;</div>
</div><!-- fragment --><p> <code>&lt;power_load&gt;</code> is a consumer-specific parameter. You can set this to a high value to see what happens when the battery drains. All others are properties of the battery.</p>
<p>Next, you can find a description of the SDF parameters used:</p>
<ul>
<li><code>&lt;battery_name&gt;</code>: The name of the battery.</li>
<li><code>&lt;voltage&gt;</code>: Initial voltage of the battery (V).</li>
<li><code>&lt;open_circuit_voltage_constant_coef&gt;</code>: Voltage at full charge (V).</li>
<li><code>&lt;capacity&gt;</code>: Total charge that the battery can hold (Ah).</li>
<li><code>&lt;power_load&gt;</code>: Power load on battery (W).</li>
<li><code>&lt;fix_issue_225&gt;</code>: As reported <a href="https://github.com/gazebosim/gz-sim/issues/225">here</a>, there are some issues affecting batteries in Gazebo Blueprint and Citadel. This parameter fixes the issues. Feel free to omit the parameter if you have legacy code and want to preserve the old behavior.</li>
<li><code>&lt;start_draining&gt;</code>: Start draining battery from the begining of the simulation. If this is not set the battery draining can only be started through the topics set through .</li>
<li><code>&lt;start_power_draining_topic&gt;</code>: Topic(s) that can be used to start power draining.</li>
<li><code>&lt;stop_power_draining_topic&gt;</code>: Topic(s) that can be used to stop power draining.</li>
<li><code>&lt;fix_issue_225&gt;</code>: As reported <a href="https://github.com/gazebosim/gz-sim/issues/225">here</a>, there are some issues affecting batteries in Ignition Blueprint and Citadel. This parameter fixes the issues. Feel free to omit the parameter if you have legacy code and want to preserve the old behavior.</li>
</ul>
<p>When setting the <code>&lt;capacity&gt;</code>, <code>&lt;voltage&gt;</code> of the battery and its <code>&lt;power_load&gt;</code>, keep in mind the following formula:</p>
<p><code>battery_runtime</code> (hours) = <code>&lt;capacity&gt;</code> * <code>&lt;voltage&gt;</code> / <code>&lt;power_load&gt;</code></p>
<h3><a class="anchor" id="autotoc_md27"></a>
Known limitations</h3>
<p>If <code>&lt;fix_issue_225&gt;</code> is not set, the battery drains at a faster (100x) rate. In this case, the battery runtime should be calculated as follows:</p>
<p><code>battery_runtime</code> (hours) = <code>&lt;capacity&gt;</code> * <code>&lt;voltage&gt;</code> / (<code>&lt;power_load&gt;</code> * 100)</p>
<h2><a class="anchor" id="autotoc_md28"></a>
Try a more realistic battery</h2>
<p>If you need to model a more realistic battery, you can use the following advanced SDF parameters:</p>
<ul>
<li><code>&lt;open_circuit_voltage_linear_coef&gt;</code>: Amount of voltage decrease when no charge (V).</li>
<li><code>&lt;initial_charge&gt;</code>: Initial charge of the battery (Ah).</li>
<li><code>&lt;resistance&gt;</code>: Internal resistance (Ohm)</li>
<li><code>&lt;smooth_current_tau&gt;</code>: Coefficient for smoothing current.</li>
</ul>
<p>Please, refer to the battery specification to set the advanced values.</p>
<h2><a class="anchor" id="autotoc_md29"></a>
Charging</h2>
<p>A battery can be charged if the SDF parameter <code>&lt;enable_recharge&gt;</code> is set to true. Here are the relevant SDF parameters related with charging:</p>
<ul>
<li><code>&lt;enable_recharge&gt;</code>: As mentioned, it should be <code>true</code> to enable recharging.</li>
<li><code>&lt;charging_time&gt;</code>: Hours taken to fully charge the battery. Keep in mind that this value assumes no battery load while charging. If the battery is under load, it will take a longer time to recharge.</li>
<li><code>&lt;recharge_by_topic&gt;</code>: If true, the start/stop signals for recharging the battery will also be available via topics. The regular Gazebo services will still be available.</li>
</ul>
<p>By default, two Gazebo Transport services are available for managing charging:</p>
<ul>
<li><code>/model/&lt;model_name&gt;/battery/&lt;battery_name&gt;/recharge/start</code>: Enable recharging.</li>
<li><code>/model/&lt;model_name&gt;/battery/&lt;battery_name&gt;/recharge/stop</code>: Disable recharging.</li>
</ul>
<p>Both services accept an <code>gz::msgs::Boolean</code> parameter.</p>
<h2><a class="anchor" id="autotoc_md30"></a>
Try out an example</h2>
<p>A battery has been added to a demo world, which can be run using:</p>
<div class="fragment"><div class="line">gz sim -v 4 linear_battery_demo.sdf -z 1000000</div>
</div><!-- fragment --><p>The blue vehicle on the left has a battery, while the one on the right does not. When the battery drains, the corresponding vehicle stops moving. Please, see <code>gz-sim/examples/worlds/linear_battery_demo.sdf</code>, where you can find the commands to visualize the state of the battery, as well as commands to start and stop the recharging.</p>
<p>To control the vehicles with keyboard, run</p>
<div class="fragment"><div class="line">cd gz-sim/examples/standalone/keyboard</div>
<div class="line">mkdir build &amp;&amp; cd build</div>
<div class="line">cmake .. &amp;&amp; make</div>
<div class="line">./keyboard ../keyboard.sdf</div>
</div><!-- fragment --><p> See more about the usage of the keyboard plugin in <code>examples/standalone/keyboard/README.md</code>.</p>
<h2><a class="anchor" id="autotoc_md31"></a>
Creating battery consumers from other systems</h2>
<p>You can easily create battery consumers from other systems by creating a consumer entity that holds a <code>BatteryPowerLoad</code> component.</p>
<h3><a class="anchor" id="autotoc_md32"></a>
Example of the Thruster system as a battery consumer</h3>
<p>It is entirely up to the developer to set the means and ways to calculate the power load of the system and the options for future users of the system. Basically all the system needs to do is to set up an entity and add the <code>BatteryPowerLoad</code> component with the corresponding information, the rest is up to the developer. However the <code>Thruster</code> system is a good example of how to make a system consume power from a certain battery.</p>
<p>The way the <code>Thruster</code> system allows users to set it as a battery consumer is through the options <code>&lt;power_load&gt;</code> and <code>&lt;battery_name&gt;</code>. Through these options the system user can set how much power load should the system consume and which battery should it use. Take note that, with this approach of identifying batteries the user would have to ensure that the battery names are unique within the system.</p>
<h4><a class="anchor" id="autotoc_md33"></a>
Configure step</h4>
<p>At the configure step the parameters are read and saved:</p>
<div class="fragment"><div class="line">if (_sdf-&gt;HasElement(&quot;power_load&quot;))</div>
<div class="line">{</div>
<div class="line">  if (!_sdf-&gt;HasElement(&quot;battery_name&quot;))</div>
<div class="line">  {</div>
<div class="line">    gzerr &lt;&lt; &quot;Specified a &lt;power_load&gt; but missing &lt;battery_name&gt;.&quot;</div>
<div class="line">        &quot;Specify a battery name so the power load can be assigned to it.&quot;</div>
<div class="line">        &lt;&lt; std::endl;</div>
<div class="line">  }</div>
<div class="line">  else</div>
<div class="line">  {</div>
<div class="line">    this-&gt;dataPtr-&gt;powerLoad = _sdf-&gt;Get&lt;double&gt;(&quot;power_load&quot;);</div>
<div class="line">    this-&gt;dataPtr-&gt;batteryName = _sdf-&gt;Get&lt;std::string&gt;(&quot;battery_name&quot;);</div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --><p>Note that both are required, if no <code>power_load</code> present then <code>battery_name</code> is ignored and if no <code>battery_name</code> is there when a <code>power_load</code> is set an error will be thrown asking for this parameter.</p>
<h4><a class="anchor" id="autotoc_md34"></a>
PreUpdate step</h4>
<p>During this step and only for one time the battery consumer will be set. This is done in this step instead of doing it in the configure step to avoid race conditions and make sure all the batteries are ready. The <code>batteryInitialized</code> makes sure the initialization only happens once.</p>
<div class="fragment"><div class="line">// Intit battery consumption if it was set</div>
<div class="line">if (!this-&gt;dataPtr-&gt;batteryName.empty() &amp;&amp;</div>
<div class="line">    !this-&gt;dataPtr-&gt;batteryInitialized)</div>
<div class="line">{</div>
<div class="line">  this-&gt;dataPtr-&gt;batteryInitialized = true;</div>
<div class="line">  ...</div>
</div><!-- fragment --><p>The battery entity is searched using the <code>ecm</code> and saved to later add the info to the <code>BatteryPowerLoad</code> component.</p>
<div class="fragment"><div class="line">// Check that a battery exists with the specified name</div>
<div class="line">Entity batteryEntity;</div>
<div class="line">int numBatteriesWithName = 0;</div>
<div class="line">_ecm.Each&lt;components::BatterySoC, components::Name&gt;(</div>
<div class="line">  [&amp;](const Entity &amp;_entity,</div>
<div class="line">    const components::BatterySoC */*_BatterySoC*/,</div>
<div class="line">    const components::Name *_name)-&gt;bool</div>
<div class="line">  {</div>
<div class="line">    if (this-&gt;dataPtr-&gt;batteryName == _name-&gt;Data())</div>
<div class="line">    {</div>
<div class="line">      ++numBatteriesWithName;</div>
<div class="line">      batteryEntity = _entity;</div>
<div class="line">    }</div>
<div class="line">    return true;</div>
<div class="line">  });</div>
</div><!-- fragment --><p>Some errors are thrown if no batteries or more than one batteries are found with the specified name.</p>
<div class="fragment"><div class="line">if (numBatteriesWithName == 0)</div>
<div class="line"> {</div>
<div class="line">   gzerr &lt;&lt; &quot;Can&#39;t assign battery consumption to battery: [&quot;</div>
<div class="line">          &lt;&lt; this-&gt;dataPtr-&gt;batteryName &lt;&lt; &quot;]. No batteries&quot;</div>
<div class="line">          &quot;were found with the given name.&quot; &lt;&lt; std::endl;</div>
<div class="line">   return;</div>
<div class="line"> }</div>
<div class="line"> if (numBatteriesWithName &gt; 1)</div>
<div class="line"> {</div>
<div class="line">   gzerr &lt;&lt; &quot;More than one battery found with name: [&quot;</div>
<div class="line">          &lt;&lt; this-&gt;dataPtr-&gt;batteryName &lt;&lt; &quot;]. Please make&quot;</div>
<div class="line">          &quot;sure battery names are unique within the system.&quot;</div>
<div class="line">          &lt;&lt; std::endl;</div>
<div class="line">   return;</div>
<div class="line"> }</div>
</div><!-- fragment --><p>Note that in this example the name is used to uniquely identify a battery within a system but it is up to the developer to use any other means they consider adequate. I.e. some sort of hierarchy can be enforced in the system to help identify batteries using this hierarchy.</p>
<p>Finally, the consumer entity is created and the power load and battery info added to its <code>BatteryPowerLoad</code> component:</p>
<div class="fragment"><div class="line">  // Create the battery consumer entity and its component</div>
<div class="line">  this-&gt;dataPtr-&gt;consumerEntity = _ecm.CreateEntity();</div>
<div class="line">  components::BatteryPowerLoadInfo batteryPowerLoadInfo{</div>
<div class="line">      batteryEntity, this-&gt;dataPtr-&gt;powerLoad};</div>
<div class="line">  _ecm.CreateComponent(this-&gt;dataPtr-&gt;consumerEntity,</div>
<div class="line">      components::BatteryPowerLoad(batteryPowerLoadInfo));</div>
<div class="line">  _ecm.SetParentEntity(this-&gt;dataPtr-&gt;consumerEntity, batteryEntity);</div>
<div class="line">}</div>
</div><!-- fragment --><p>The <code>consumerEntity</code> is saved in case it has to be modified or even deleted in the future. If a developer wants to change the power load they just need to modify the component, setting it to 0 will stop the consumer effect on the battery. Another option is to entirely delete the consumer entity.</p>
<p>The battery plugin basically checks for entities with a <code>BatteryPowerLoad</code> component and uses that information to calculate the total battery consumption before the draining step happens. By modifying the values and quantities of entities with <code>BatteryPowerLoad</code> components developers can add, modify and remove battery consumers from the different batteries available in a system.</p>
<h2><a class="anchor" id="autotoc_md35"></a>
Known Issues</h2>
<ul>
<li>The rate of consumption should be affected by torque. For example, going uphill should consume more power than going downhill. </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
      </div>
    </main>
  </div>
</body>
