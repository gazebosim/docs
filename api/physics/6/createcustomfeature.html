<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=9"/>
    <meta name="keywords" content="Gazebo Physics">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Gazebo Physics: Implement a custom feature</title>
    <script type="text/javascript" src="https://gazebosim.org/assets/doxygen/dynsections.js"></script>
    <script type="text/javascript" src="jquery.js"></script>
    <link rel="icon" type="image/x-icon" href="https://gazebosim.org/assets/icon/favicon.ico">
    <link href='http://fonts.googleapis.com/css?family=Roboto:400,300,100,500,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.deep_orange-blue.min.css">
    <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>
    <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"> </script>
    <link href="https://gazebosim.org/assets/doxygen/doxygen.css" rel="stylesheet" type="text/css">
  </head>
    <script type="text/javascript">
      /* Replace all the "permalink" &#9670;&nbsp; icons with a unicode link
        symbol.*/
      $(document).ready(function() {
        var elems = document.getElementsByClassName("permalink");
        for (var i = 0; i < elems.length; ++i) {
          elems[i].firstChild.innerHTML="&#x1f517;";
          elems[i].firstChild.style.fontSize="18px";
        }
      });
    </script>
  </head>
<body>
  <div class="mdl-layout mdl-js-layout mdl-layout--fixed-drawer">
    <div class="mdl-layout__drawer mdl-color--grey-100 mdl-color-text--blue-grey-50">
      <header class="mdl-color--grey-100">
        <a href="index.html"><img width="60px" src="https://gazebosim.org/assets/doxygen/gazebo_logo.svg"/></a>
        <h1 class="project_title">Gazebo Physics</h1>
        <h2>API Reference</h2>
        <div class="version">
        6.6.0
        </div>
      </header>
      <!-- NOTE: If you add a link to a doxygen generated page, then make
                 sure to update the required_html_fils list in
                 GzCreateDocs.cmake -->
      <nav class="gz-navigation mdl-navigation">
        <a class="mdl-navigation__link" href="tutorials.html">
          <i class="mdl-color-text--grey-400 material-icons"
             role="presentation">insert_drive_file</i>Tutorials</a>
        <a id="class_menu" class="mdl-navigation__link" href="#">
          <i class="mdl-color-text--grey-400 material-icons"
             role="presentation">library_books</i>Classes</a>
        <a id="namespaces_menu"class="mdl-navigation__link" href="#">
          <i class="mdl-color-text--grey-400 material-icons"
             role="presentation">toc</i>Namespaces</a>
        <a class="mdl-navigation__link" href="files.html">
          <i class="mdl-color-text--grey-400 material-icons"
             role="presentation">insert_drive_file</i>Files</a>
        <a class="mdl-navigation__link" target="_blank"
           href="http://gazebosim.org">
          <i class="mdl-color-text--grey-400 material-icons"
             role="presentation">launch</i>Gazebo Website</a>
      </nav>
      <!-- classes sub menu -->
      <ul for="class_menu" class="mdl-menu mdl-menu--bottom-left mdl-js-menu mdl-js-ripple-effect mdl-navigation">
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link" href="classes.html">Index</a>
        </li>
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link"
            href="annotated.html">List</a>
        </li>
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link"
             href="hierarchy.html">Hierarchy</a>
        </li>
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link"
             href="functions.html">Members: All</a>
        </li>
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link"
             href="functions_func.html">Members: Functions</a>
        </li>
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link"
             href="functions_vars.html">Members: Variables</a>
        </li>
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link"
             href="functions_type.html">Members: Typedefs</a>
        </li>
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link"
             href="functions_enum.html">Members: Enumerations</a>
        </li>
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link"
             href="functions_eval.html">Members: Enumerator</a>
        </li>
      </ul>
      <!-- namespaces sub menu -->
      <ul for="namespaces_menu" class="mdl-menu mdl-menu--bottom-left mdl-js-menu mdl-js-ripple-effect mdl-navigation">
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link"
            href="namespaces.html">List</a>
        </li>
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link"
            href="namespacemembers.html">Members</a>
        </li>
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link"
            href="namespacemembers_func.html">Functions</a>
        </li>
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link"
            href="namespacemembers_type.html">Typedefs</a>
        </li>
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link"
            href="namespacemembers_vars.html">Variables</a>
        </li>
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link"
            href="namespacemembers_enum.html">Enumerations</a>
        </li>
        <li class="mdl-menu__item">
          <a class="mdl-navigation__link"
            href="namespacemembers_eval.html">Enumerator</a>
        </li>
      </ul>
    </div>
    <main class="mdl-layout__content mdl-color--white">
    <div id="top">
<!-- Generated by Doxygen 1.8.17 -->
</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Implement a custom feature </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h2><a class="anchor" id="autotoc_md59"></a>
Prerequisites</h2>
<ul>
<li><a class="el" href="installation.html">Installation</a></li>
<li><a class="el" href="physicsplugin.html">Understanding the physics plugin</a></li>
<li><a class="el" href="pluginloading.html">Loading physics plugins</a></li>
<li><a class="el" href="createphysicsplugin.html">Implement a physics feature</a></li>
</ul>
<h2><a class="anchor" id="autotoc_md60"></a>
Implement a custom feature in DART plugin</h2>
<p>In the last <a class="el" href="createphysicsplugin.html">Implement a physics feature</a> tutorial, we know how to implement a dummy physics engine as a plugin and load it using <a class="el" href="namespacegz_1_1physics.html">Gazebo Physics API</a>. In this tutorial, we will look deeper into the structure of a physics engine plugin, for example, the available <a href="https://github.com/gazebosim/gz-physics/tree/main/dartsim">DART</a> physics engine in <code>gz-physics</code> repository and how to define a custom <a class="el" href="classgz_1_1physics_1_1Feature.html">Feature</a> for the plugin.</p>
<h3><a class="anchor" id="autotoc_md61"></a>
Folder structure of the plugins</h3>
<p>Below is the general structure of the <code>gz-physics</code> repository:</p>
<div class="fragment"><div class="line">gz-physics</div>
<div class="line">├── dartsim                   Files for dartsim plugin component.</div>
<div class="line">├── tpe                       Files for tpe plugin component.</div>
<div class="line">├── heightmap                 Files for heightmap component.</div>
<div class="line">├── include/gz/physics  Header files.</div>
<div class="line">├── mesh                      Files for mesh component.</div>
<div class="line">├── resources                 Model and mesh resource files used by tests.</div>
<div class="line">├── sdf                       Files for sdf component.</div>
<div class="line">├── src                       Source files and unit tests.</div>
<div class="line">├── test</div>
<div class="line">├── tutorials                 Tutorials, written in markdown.</div>
<div class="line">├── Changelog.md              Changelog.</div>
<div class="line">└── CMakeLists.txt            CMake build script.</div>
</div><!-- fragment --><p>As shown above, there are two physics engines available:</p><ul>
<li><b>DART</b>: <code>gz-physics-dartsim-plugin</code>.</li>
<li><b>TPE</b>: <code>gz-physics-tpe-plugin</code>.</li>
</ul>
<p>and their plugin folders are placed just below the top level of <code>gz-physics</code>.</p>
<p>Looking closer to a plugin folder, for example, the <code>dartsim</code> (DART) plugin:</p>
<div class="fragment"><div class="line">dartsim</div>
<div class="line">├── worlds                            Example SDF files for testing dartsim plugin functionalities.</div>
<div class="line">├── src                               Main implementation files of the plugin features interfacing the physics engines API</div>
<div class="line">├── include/gz/physics/dartsim  Header files for the plugin features.</div>
<div class="line">└── CMakeLists.txt                    CMake plugin build script.</div>
</div><!-- fragment --><p>Basically, new implementation of <a class="el" href="classgz_1_1physics_1_1Feature.html">Feature</a> or <a class="el" href="structgz_1_1physics_1_1FeatureList.html">FeatureList</a>, which is corresponded to a functionality of the external physics engine can be defined as a header in <code>include/gz/physics/&lt;plugin_name&gt;</code> folder. The custom feature could be added in a <a class="el" href="structgz_1_1physics_1_1FeatureList.html">FeatureList</a> and implemented its functionalities in <code>src</code> folder.</p>
<p>See the <a class="el" href="physicsplugin.html">Understanding the physics plugin</a> tutorial for details on physics engines.</p>
<h3><a class="anchor" id="autotoc_md62"></a>
Plugin and feature requirements</h3>
<p>In general, the minimum set of features that any physics engine plugin must implement to be supported by Gazebo is as below:</p><ul>
<li>FindFreeGroupFeature</li>
<li><a class="el" href="classgz_1_1physics_1_1SetFreeGroupWorldPose.html">SetFreeGroupWorldPose</a></li>
<li><a class="el" href="classgz_1_1physics_1_1FreeGroupFrameSemantics.html">FreeGroupFrameSemantics</a></li>
<li><a class="el" href="classgz_1_1physics_1_1LinkFrameSemantics.html">LinkFrameSemantics</a></li>
<li><a class="el" href="classgz_1_1physics_1_1ForwardStep.html">ForwardStep</a></li>
<li><a class="el" href="namespacegz_1_1physics.html#a1a4dd0ee382cadb1351af5d7e2120693">RemoveEntities</a></li>
<li><a class="el" href="classgz_1_1physics_1_1sdf_1_1ConstructSdfLink.html">ConstructSdfLink</a></li>
<li><a class="el" href="classgz_1_1physics_1_1sdf_1_1ConstructSdfModel.html">ConstructSdfModel</a></li>
<li><a class="el" href="classgz_1_1physics_1_1sdf_1_1ConstructSdfWorld.html">ConstructSdfWorld</a></li>
</ul>
<p>This list defines the minimum requirements for the simulation capability of a physics engine plugin and also maintains backward compatibility with downstream physics plugins.</p>
<p>For custom feature requirements, there are two main component classes in the general structure of a custom feature:</p><ul>
<li><p class="startli"><a class="el" href="classgz_1_1physics_1_1Entity.html">Entity</a> corresponds to the "proxy object" that the <a class="el" href="classgz_1_1physics_1_1Feature.html">Feature</a> is implemented. These are the most common "proxy objects" that are inherited from <code>Entity</code> class:</p><ul>
<li><a class="el" href="classgz_1_1physics_1_1Feature_1_1Engine.html">Engine</a>: Placeholder class for the Engine API. This class serves metadata for the physics engine (for example the <a class="el" href="classgz_1_1physics_1_1GetEngineInfo.html">GetEngineInfo</a> feature). Every Engine feature <b>must</b> inherit this class.</li>
<li><a class="el" href="classgz_1_1physics_1_1Feature_1_1Joint.html">Joint</a>: defines physics concept <code>Joint</code> behaviors (for example the <a class="el" href="classgz_1_1physics_1_1GetBasicJointState.html">GetBasicJointState</a> feature).</li>
<li><a class="el" href="classgz_1_1physics_1_1Feature_1_1Link.html">Link</a>: defines physics concept <code>Link</code> structure.</li>
<li><a class="el" href="classgz_1_1physics_1_1Feature_1_1Model.html">Model</a>: defines physics concept <code>Model</code> structure (for example the <a class="el" href="classgz_1_1physics_1_1GetLinkFromModel.html">GetLinkFromModel</a> feature including both <code>Link</code> and <code>Model</code> objects).</li>
<li><a class="el" href="classgz_1_1physics_1_1Feature_1_1Shape.html">Shape</a>: defines physics concept <code>Shape</code> structure (for example the <a class="el" href="classgz_1_1physics_1_1GetShapeKinematicProperties.html">GetShapeKinematicProperties</a> feature).</li>
<li><a class="el" href="classgz_1_1physics_1_1Feature_1_1World.html">World</a>: defines physics concept <code>Shape</code> structure (for example the <a class="el" href="classgz_1_1physics_1_1dartsim_1_1RetrieveWorld.html">RetrieveWorld</a> feature in <code>dartsim</code> plugin).</li>
</ul>
<p class="startli">Note that these object classes are not mutually exclusive and could be defined in conjunction together to describe the <code>Feature</code>. There are also other uncommon objects defined depending on feature functionality, for example, the <a class="el" href="classgz_1_1physics_1_1SetFreeGroupWorldPose_1_1FreeGroup.html">FreeGroup</a> object in <code>SetFreeGroupWorldPose</code> feature. For more information about the physics concepts, please refer to <a class="el" href="physicsconcepts.html">Gazebo Physics simulation concepts</a> tutorial.</p>
</li>
<li><a class="el" href="classgz_1_1physics_1_1Feature_1_1Implementation.html">Implementation</a> interfaces the actual physics engines API for the custom feature. It has <a class="el" href="classgz_1_1physics_1_1Feature_1_1Implementation.html#a6003260cc937b7e4d39a08e6eadd65e8">InitiateEngine</a> to trigger physics engine initiation to provide the required functionalities.</li>
</ul>
<p>Moreover, we can define dependencies between custom <code>Features</code>:</p><ul>
<li>By default, a blank feature will not require any other features. If the custom feature does require some other set of features, then it should be inherited from <a class="el" href="structgz_1_1physics_1_1FeatureWithRequirements.html">FeatureWithRequirements</a> class, and provided a list of the <code>Features</code> required.</li>
<li>By default, a blank feature will not conflict with any other features. If the custom feature does conflict with some other set of features, then it should be inherited from <a class="el" href="structgz_1_1physics_1_1FeatureWithConflicts.html">FeatureWithConflicts</a> class, and provided a list of the conflicting <code>Features</code>. The conflicting <code>Features</code> will not run at the same time when requested.</li>
</ul>
<h3><a class="anchor" id="autotoc_md63"></a>
Define custom feature template</h3>
<p>With the requirements and restrictions above, we first need to define a feature template for the custom feature. In this case, this feature will be responsible for retrieving world pointer from the physics engine. The template is placed in <a href="https://github.com/gazebosim/gz-physics/blob/main/dartsim/include/gz/physics/dartsim/World.hh">World.hh</a>:</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> PolicyT, <span class="keyword">typename</span> FeaturesT&gt;</div>
<div class="line">dart::simulation::WorldPtr RetrieveWorld::World&lt;PolicyT, FeaturesT&gt;</div>
<div class="line">::GetDartsimWorld()</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">return</span> this-&gt;<span class="keyword">template</span> Interface&lt;RetrieveWorld&gt;()</div>
<div class="line">      -&gt;GetDartsimWorld(this-&gt;identity);</div>
<div class="line">}</div>
</div><!-- fragment --><p> The <code>RetrieveWorld</code> feature retrieves world pointer from physics engine, so we will use the <code>World</code> entity inherited from <a class="el" href="classgz_1_1physics_1_1Feature_1_1World.html">Feature::World</a> and declare the member function <code>GetDartsimWorld</code>. Then we substantiate the virtual <code>Implementation</code> member function by overriding in the actual implementation of the custom feature <code>RetrieveWorld</code> later.</p>
<p>Finally, we implement the <code>World</code> entity's member function <code>GetDartsimWorld</code> to call the <code>Implementation</code> class's member function <code>GetDartsimWorld</code> via Entity::Interface convenience function for querying the feature <code>Implementation</code> object.</p>
<p>The newly defined feature template is placed in an <code>/include</code> folder shown in the following structure:</p>
<div class="fragment"><div class="line">dartsim</div>
<div class="line">├── worlds</div>
<div class="line">├── src</div>
<div class="line">│    ├── CustomFeatures.hh</div>
<div class="line">│    ├── CustomFeatures.cc</div>
<div class="line">│    └── ...</div>
<div class="line">├── include/gz/physics/dartsim</div>
<div class="line">│    └──  World.hh</div>
<div class="line">└── CMakeLists.txt</div>
</div><!-- fragment --><p>We put this custom feature template in <code>dartsim</code>, and the next step is to implement the <code>RetrieveWorld</code> feature function using Dartsim API.</p>
<h3><a class="anchor" id="autotoc_md64"></a>
Implement the custom feature</h3>
<p>After defining the feature template, we can add it to a custom <a class="el" href="structgz_1_1physics_1_1FeatureList.html">FeatureList</a>:</p>
<div class="fragment"><div class="line"><span class="keyword">using</span> CustomFeatureList = FeatureList&lt;</div>
<div class="line">  RetrieveWorld</div>
<div class="line">&gt;;</div>
</div><!-- fragment --><p> The custom feature <code>RetrieveWorld</code> is added to <code>CustomFeatureList</code>, other custom features could also be added here. The <code>CustomFeatures</code> "FeatureList" here uses data structures and classes from:</p><ul>
<li><a href="https://github.com/gazebosim/gz-physics/blob/ign-physics2/dartsim/src/Base.hh">Base.hh</a>, which defines structures that contain information to create <code>Model</code>, <code>Joint</code>, <code>Link</code>, and <code>Shape</code> objects in Dartsim API. They act as an interface between Gazebo Physics Library and the actual physics engine.</li>
<li><a class="el" href="namespacegz_1_1physics.html#a6d38e59cc9ee7d1edeb9af2205aac83d">Implements3d</a> for implementing the custom feature with <a class="el" href="namespacegz_1_1physics.html#a7f245b484b6675dbb78f5b1aa68790b2">FeaturePolicy3d</a> ("FeaturePolicy" of 3 dimensions and scalar type <code>double</code>).</li>
</ul>
<p>We will then implement the actual function with Dartsim API in <a href="https://github.com/gazebosim/gz-physics/blob/ign-physics2/dartsim/src/CustomFeatures.cc">CustomFeatures.cc</a> to override the member function declared in the custom feature header file:</p>
<div class="fragment"><div class="line">dart::simulation::WorldPtr CustomFeatures::GetDartsimWorld(</div>
<div class="line">    <span class="keyword">const</span> Identity &amp;_worldID)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">return</span> this-&gt;worlds.at(_worldID);</div>
<div class="line">}</div>
</div><!-- fragment --><p> Here, we implement the behavior of <code>GetDartsimWorld</code> with Dartsim API to return the world pointer from <code>EntityStorage</code> object storing world pointers of <code>dartsim</code> in <a href="https://github.com/gazebosim/gz-physics/blob/ign-physics2/dartsim/src/Base.hh">Base</a> class.</p>
<p>In the end, we add the implemented <code>CustomFeatures</code> "FeatureList" together with other <a class="el" href="structgz_1_1physics_1_1FeatureList.html">FeatureList</a> to final <code>DartsimFeatures</code> "FeatureList" as in <a href="https://github.com/gazebosim/gz-physics/blob/ign-physics2/dartsim/src/plugin.cc">dartsim/src/plugin.cc</a> (please see the <a class="el" href="createphysicsplugin.html">Implement a physics feature</a> tutorial for registering the plugin to Gazebo Physics).</p>
<p>The folder structure is shown below:</p>
<div class="fragment"><div class="line">dartsim</div>
<div class="line">├── worlds</div>
<div class="line">├── src</div>
<div class="line">│    ├── CustomFeatures.hh</div>
<div class="line">│    ├── CustomFeatures.cc</div>
<div class="line">│    ├── ...</div>
<div class="line">├── include/gz/physics/dartsim</div>
<div class="line">└── CMakeLists.txt</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
      </div>
    </main>
  </div>
</body>
